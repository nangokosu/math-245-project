---
title: "Project proposal"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE,warning=F,message=F}
knitr::opts_chunk$set(echo = TRUE)
```

## Project proposal:
Our project seeks to use a variety of Gapminder country level statistics from 2016 to determine which variables correlate strongly with the overall level of happiness in a country (as measured by the Happiness Index), and how.

```{r}
library(tidyverse)
library(GGally)
library(ggplot2)
library(caret)
library(MASS)
```


```{r}
df=readRDS("./merged_gapminder_happiness.rds")
df_variables=df%>%dplyr::select(-country,-year)
```

```{r}
summary(df_variables)
par(mfrow=c(4,5))
for(i in colnames(df_variables)) {
  hist = hist(na.omit(df_variables[[i]]), breaks = 20, main = paste("Distribution of", i),xlab=NULL)
}
for(i in colnames(df_variables)) {
  boxplot = boxplot(na.omit(df_variables[[i]]), main = paste("Boxplot of", i),xlab=NULL)
}
hist(na.omit(df_variables$hapiscore_whr))
boxplot(na.omit(df_variables$hapiscore_whr))
sd(na.omit(df_variables$hapiscore_whr))
```

Description & distribution of each variable:
                         
country: The country variable includes 241 observations, including Australia, United States, Canada, Japan, and Virgin Islands, Taiwan, Hong Kong, and Macau. 
year: The year variable is 2014, which is the most recent year with sufficient level of data for our regression analysis. 

For each country
parliament: Percentage of national parliamentary seats held by women. Lower and upper houses combined.
Distribution - skewed right, normal.

hapiscore_whr: This is the national average response to the question of life evaluations asking the following “Please imagine a ladder, with steps numbered from 0 at the bottom to 10 at the top. The top of the ladder represents the best possible life for you and the bottom of the ladder represents the worst possible life for you. On which step of the ladder would you say you personally feel you stand at this time?” This measure is also referred to as Cantril life ladder. Gapminder has converted this indicator's scale from 0 to 100 to easily communicate it in terms of percentage.
Distribution - mild hump/stretched-out normal curve with wide spread
IQR: 9.52500, variance: 6.312879e+01, standard deviation: 7.945363e+00

aged_15plus_unemployment_rate_percent: Percentage of total population, age group above 15, that has been registered as unemployed during the given year.
Distribution - normal
IQR: 11.77500, variance: 8.424851e+01, standard deviation: 9.178698e+00

right: Fundamental Rights in the form of liberal and social rights support both fair representation and the vertical 
mechanism of accountability that the first attribute seeks to achieve. This attribute is composed of three 
subattributes: access to justice, civil liberties, and social rights and equality. The three subattributes were 
aggregated into the Fundamental Rights index using BFA (source: Skaning 2019 via https://www.idea.int/gsod-indices/sites/default/files/idea-gsodi-2019-codebook-v3.pdf )
Distribution: normal/hump, wide spread
IQR: 6.95000, variance: 7.135659e+01, standard deviation: 8.447283e+00

sanitation: percentage of people using improved sanitation facilities that are not shared with other households.
distribution - uniform/linear then with sharp jump/exponential increase at 100%.
IQR:  22.82500, variance: 1.784627e+02, standard deviation: 1.335899e+01

hdiindex: Human Development Index (HDI) https://www.hdr.undp.org/en/content/human-development-index-hdi
distribution - concave down increasing, wide spread.
IQR: 0.02125, variance: 9.375379e-04, standard deviation: 3.061924e-02

edu: Education index calculated based on Avg years of schooling, taking values 0 as minimum and 15 as maximum
Distribution - wide spread.
IQR: 12.12500, variance: 8.859174e+01, standard deviation: 9.412319e+00

internetusers: Percentage of Population with stable Internet access
Distribution - multimodal, wide spread.
IQR: 19.22500, variance: 2.372645e+02, standard deviation: 1.540339e+01

sdi: The Sustainable Development Index is an efficiency metric, designed to assess the ecological efficiency of nations in delivering human development. It is calculated as the quotient of two figures: (1) a “development index” based on the Human Development Index, calculated as the geometric mean of the life expectancy index, the education index, and a modified income index; and (2) an “ecological impact index” calculated as the extent to which consumption-based CO2 emissions and material footprint exceed per-capita shares of planetary boundaries.
Distribution - seemingly linearly increasing, or skewed left.
IQR: 5.17500, variance: 1.093839e+02, standard deviation: 1.045867e+01

forestcoverage: Percentage of total land area that has been covered with forest
Distribution - Seemingly decreasing.
IQR: 18.10500, variance: 3.058635e+02, standard deviation: 1.748895e+01

militaryexpenditure: Military expenditure as a percentage of GDP.
Distribution - Right skewed normal with outliers at larger values. 
IQR: 0.78975, variance: 2.334034e+00, standard deviation: 1.527755e+00

mortality: Newborn mortality rate per 1000
Distribution - decreasing
IQR: 6.22500, variance: 1.591720e+01, standard deviation: 3.989636e+00

wateraccess: Percentage of people with at least basic water services
Distribution - exponentially increasing.
IQR: 7.25000, variance: 2.993909e+01, standard deviation: 5.471663e+00

broadband: Broadband subscribers per 100 people
Distribution - steep drop/potentially exponentially decreasing.
IQR: 9.98500, variance: 4.516839e+01, standard deviation: 6.720743e+00

agriculture: Percentage of land area that is arable
Distribution - wide-ranging
IQR: 13.02500, variance: 2.622336e+02, standard deviation: 1.619363e+01

debt: Total debt service (% of GNI)
Distribution - Sharp decrease then flat
IQR: 6.64000, variance: 3.385360e+01, standard deviation: 5.818385e+00

gdppercapita_growth: GDP per capita
Distribution  - decreasing with outliers
IQR: 2.13000, variance: 2.543614e+00, standard deviation: 1.594871e+00

foodinsecurity: Prevalence of moderate or severe food insecurity in the population
Distribution - normal skewed right
IQR: 9.55000, variance: 1.128336e+02, standard deviation: 1.062232e+01

Exports:% of GNP: exports of goods & services, include the value of merchandise, freight, insurance, transport, travel
Data source: https://data.worldbank.org/indicator/NE.EXP.GNFS.ZS
IQR: 20.17500, variance: 2.426063e+02, standard deviation: 1.557582e+01

Corruption Perception Index (CPI): Transparency International's score of perceptions of corruption. Higher value indicates less corruption.
Data source: http://www.transparency.org/research/cpi
IQR: 3.25000, variance: 8.818182e+00, standard deviation: 2.969542e+00

Income: Income per person adjusted for purchasing power
Data Source: World Bank, http:llgapm.io/dgdppc
IQR: 5350.00000, variance: 2.689152e+07, standard deviation: 5.185703e+03

Vaccine: Proportion of people who disagree that vaccines are effective for children to have
Data Source: http://gapm.io/dvaccine_confidence
IQR: 5.47500, variance: 3.927970e+01, standard deviation: 6.267352e+00

## General observations 
There are some variables with significant left skew i.e beyond a certain threshold, the variable will most likely not affect the target variable any more (e.g water, sanitation).
There are some variables with significant right skew i.e below a certain threshold, the variable will most likely not affect the target variable any more (e.g debt).
There are a lot of variables with substantial numbers of missing values.

## knn imputation:
From our summary, we find that foodsecurity,vaccine and aged_15plus_unemployment_rate_percent have a high number of missing variables. However, in general, our dataset contains very few full entries (12). As such, we employ KNN imputation in order to 
fill in the missing entries.

```{r}
library(VIM)
df_variables_imputed=kNN(df_variables%>%dplyr::select(-hapiscore_whr),k=10,imp_var=F)
df_variables_imputed['hapiscore_whr']=df_variables$hapiscore_whr
```

## checking knn imputation:

In order to see if our knn imputation significantly affects the relationship between variables that did not have a large number of missing entries, we compare the correlation plots before and after imputation.

```{r,fig.width=10}
ggcorr(df_variables%>%dplyr::select(-hapiscore_whr,-foodinsecurity,-aged_15plus_unemployment_rate_percent),geom="circle",layout.exp = 1)+ggtitle("Before imputation")
ggcorr(df_variables_imputed%>%dplyr::select(-hapiscore_whr,-foodinsecurity,-aged_15plus_unemployment_rate_percent),geom="circle",layout.exp = 1)+ggtitle("After imputation")
```

With knn imputation at k=10, the variable "right" is most affected, as its correlation with other variables was decreased from the imputation process. However, for reasons below, this will not be a problem.

```{r,fig.width=10}
ggcorr(df_variables_imputed%>%dplyr::select(-hapiscore_whr),geom="circle",layout.exp = 1)+ggtitle("Full correlation matrix after imputation")
```

From the graph above, we see that the following variables are relatively independent from others: gdppercapita_growth,forestcoverage,sdi,aged_15plus_unemployment_rate_percent,parliament,vaccine.

Based on this distinction, we execute a two step process:
First, we do a regression of the happiness score based on these independent features to determine those with a statistically significant effect on the target.
Second, we do a PR decomposition of the remaining variables to eliminate the multicollinearity concerns, and use the PCs cumulatively accounting for more than 80% of the total target variance for a PCR regression.
Finally, we do a PCR regression using the identified PCs alongside the independent features above.

## i 
```{r}
lm_independent=lm(hapiscore_whr~gdppercapita_growth+forestcoverage+sdi+aged_15plus_unemployment_rate_percent+parliament+vaccine,data=df_variables_imputed)
summary(lm_independent)
```

Based on the model, sdi and parliament are possible independent features. We also check for multicollinearity in the model with VIF, and see that our assumption of independence of feature variables is correct.

```{r}
car::vif(lm_independent)
```
## ii

```{r}
df_variables_remaining=df_variables_imputed%>%dplyr::select(-gdppercapita_growth,-forestcoverage,-sdi,-aged_15plus_unemployment_rate_percent,-parliament,-hapiscore_whr,-vaccine)
pr_happiness=prcomp(df_variables_remaining,scale=T,center=T)
```

```{r}
pr_var=pr_happiness$sdev^2
prop_var=pr_var/sum(pr_var)
plot(cumsum(prop_var),xlab="Number of PCs",ylab="")
```

We decide to use 4 PCs, which account for 80% of the total variance.

```{r}
pr_pc=pr_happiness$x[,1:4]
pr_pc=cbind(pr_pc,df_variables_imputed%>%dplyr::select(sdi,parliament))
pr_pc['hapiscore_whr']=df_variables$hapiscore_whr
model_pure_pcr=lm(hapiscore_whr~PC1+PC2+PC3+PC4,data=pr_pc)
model_pcr_additive=lm(hapiscore_whr~PC1+PC2+PC3+PC4+sdi+parliament,data=pr_pc)
summary(model_pcr_additive)
```
To see whether our independent features add any value to our PCR model, we conduct a model F-test using both. We see that the model with our independent variables along the PCs does not yield a better fit than the pure PCR model for parsimony, so the latter is preferred. In fact, we may only need 3 PCs rather than 4.

```{r}
anova(model_pure_pcr,model_pcr_additive,test="F")
```

```{r,fig.width=10}
model_3_pcr=lm(hapiscore_whr~PC1+PC2+PC3,data=pr_pc)
par(mfrow=c(1,2))
plot(model_pure_pcr,which=c(1))
plot(model_pure_pcr,which=c(2))
```

Based on the diagnostics plot above, while our residuals do follow a normal distribution, there seems to be less variability at higher levels of the fitted values/predicted happiness scores. 

```{r}
na_criteria=is.na(df_variables_imputed$hapiscore_whr)
train_pr=pr_pc[!na_criteria,]
test_pr=pr_pc[na_criteria,]
set.seed(123)
lm_model_final_cv=train(hapiscore_whr~PC1+PC2+PC3,
      method="lm",
      data=train_pr,
      trControl=trainControl(method="cv",number=10))
```

```{r}
predictions_train=predict(lm_model_final_cv)
predictions_test=predict(lm_model_final_cv,newdata=test_pr)
test_pr$hapiscore_whr=predictions_test
```

Additionally, when combined with the result of the 10-fold CV regression model, our model appears to have bias. This indicates either high leverage values or possible missing covariates.

```{r,fig.width=10}
ggplot(data=NULL)+
  geom_density(aes(x=train_pr$hapiscore_whr,color="training set happiness score"))+
  geom_density(aes(x=predictions_train,color="training set fitted happiness score"))+
  geom_density(aes(x=test_pr$hapiscore_whr,color="test set predicted happiness score"))+
  theme_bw()+xlab("Happiness score")
```


## Implementation using Stepwise regression (StepAIC & cross-validation):
Stepwise Regression
1. Stepwise regression allows us to choose the best model by AIC (Akaike Information Criterion), which measures how well a model fits the data that it was generated from. AIC is calculated based on the number of independent variables used to build the model, and the maximum likelihood estimate of the model. The best-fit model according to AIC is the one that is able to explain the greatest amount of variation using the fewest possible independent variables, and in statistical comparison, the smaller the AIC, the better the model fit. 
2. Stepwise AIC method, therefore, gives us the model with the smallest AIC, which in this case consists of 10 indicators, respectively foodinsecurity, unemployment rate, sanitation rate, HDI, miltary expenditure (% of GDP), debt (% of GDP), corruption, income per person, exports, and vaccine. In fitting this model, all 10 indicators are statistically significant, with foodinsecurity, unemployment rate and hdi statistically significant at the 0.1% level. 
3. The adjusted R-squared for this model is 0.7663, which means that our model reasonally well captures 76.63% of the variability in the data. The RMSE of the model is 5.340318. The AIC of the model is 1465.618. 

```{r}
res.lm <- lm(hapiscore_whr ~., data = df_variables_imputed)
step <- stepAIC(res.lm, direction = "both", trace = FALSE)
step
# Train the model
step.model <- train(hapiscore_whr ~., data = df_variables_imputed,
                    method = "lmStepAIC", 
                    trControl = train.control,
                    trace = FALSE
                    )
# Model accuracy
step.model$results
# Final model coefficients
step.model$finalModel
# Summary of the model
summary(step.model$finalModel)
```

Given that our model includes 21 predictor variables, we use nvmax from 1 to 21 to identify the best models. 
1. We also use 10-fold cross-validation to estimate the average prediction error of each of the models, and this metric allows us to directly compare the models and select the best model that minimize RMSE. 
2. Using the best tuning values, we are able to find that the model with 5 variables (respectively unemployment rate, hdi, foodinsecurity, vaccine, and income per person) is the one that has the lowest RMSE. 
3. The resulting regression shows that all 5 predictor variables are statistcially significant, and in fact, 4 out of 5 predictor variables included are significant at the 0.1% level. The Adjusted R-squared value is 0.7539. Even though the adjusted R-squared value is comparatively lower than the above-mentioned StepAIC model, this new model gives us the lowest RMSE of 5.042854 in all linear models. The AIC of the model is 1473.189. 
```{r}
# Set seed for reproducibility
set.seed(123)
# Set up repeated k-fold cross-validation
train.control <- trainControl(method = "cv", number = 10)
# Train the model
step.model1 <- train(hapiscore_whr ~parliament+aged_15plus_unemployment_rate_percent+right+sanitation+edu+internetusers+sdi+hdiindex+forestcoverage+
                       militaryexpenditure+mortality+wateraccess+broadband+agriculture+debt+gdppercapita_growth+foodinsecurity+
                       exports+corruption+vaccine+incomeperperson, data = df_variables_imputed,
                    method = "leapBackward", 
                    tuneGrid = data.frame(nvmax = 1:21),
                    trControl = train.control
                    )
step.model1$results
step.model1$bestTune
summary(step.model1$finalModel)
coef(step.model1$finalModel, 5)
model.lm2 <- lm(hapiscore_whr~aged_15plus_unemployment_rate_percent+hdiindex+foodinsecurity+vaccine+incomeperperson, data=df_variables_imputed)
summary(model.lm2)
AIC_calculated <- 2*7 + 241* (log( 2*3.14* (1-0.759)*24962/241 ) + 1)
AIC_calculated
```
